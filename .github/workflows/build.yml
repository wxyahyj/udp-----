name: Build UDP Streamer

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows-cpp:
    name: Build C++ on Windows (x64)
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup CMake and Dependencies
      run: |
        choco install cmake --no-progress -y
        cmake --version
      shell: powershell
    
    - name: Setup Visual Studio Build Tools
      uses: microsoft/setup-msbuild@v1.1
    
    - name: Setup vcpkg and install FFmpeg
      run: |
        # Install vcpkg
        cd C:\
        git clone https://github.com/Microsoft/vcpkg.git
        cd vcpkg
        .\bootstrap-vcpkg.bat
        
        # Install FFmpeg dev libs
        .\vcpkg install ffmpeg:x64-windows
        
        # Set FFmpeg path
        $ffmpeg_path = "C:\vcpkg\installed\x64-windows"
        Write-Host "FFmpeg path: $ffmpeg_path"
        Add-Content -Path $env:GITHUB_ENV -Value "FFMPEG_PATH=$ffmpeg_path"
        Add-Content -Path $env:GITHUB_ENV -Value "VCPKG_ROOT=C:\vcpkg"
      shell: powershell
    
    - name: Verify FFmpeg
      run: |
        Write-Host "Checking FFmpeg structure..."
        $ffmpeg = "${{ env.FFMPEG_PATH }}"
        Get-ChildItem "$ffmpeg" -Recurse -Filter "*.lib" | Select-Object -First 5
        Get-ChildItem "$ffmpeg" -Recurse -Filter "*.h" | Select-Object -First 5
      shell: powershell
    
    - name: Configure CMake
      run: |
        mkdir build -ErrorAction SilentlyContinue
        cd build
        
        Write-Host "Using vcpkg toolchain"
        cmake -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake" `
          -DVCPKG_TARGET_TRIPLET="x64-windows" `
          -DCMAKE_BUILD_TYPE=Release `
          ..
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "CMake configuration failed"
          exit 1
        }
      shell: powershell
    
    - name: Build C++ Project
      run: |
        cd build
        cmake --build . --config Release --parallel 4
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Build failed"
          exit 1
        }
      shell: powershell
    
    - name: Copy FFmpeg DLLs
      run: |
        $src = "C:\vcpkg\installed\x64-windows\bin"
        $dst = "build\Release"
        
        if (Test-Path $src) {
          Write-Host "Copying FFmpeg DLLs from $src to $dst"
          Copy-Item "$src\avcodec*.dll" "$dst\" -Force -ErrorAction SilentlyContinue
          Copy-Item "$src\avformat*.dll" "$dst\" -Force -ErrorAction SilentlyContinue
          Copy-Item "$src\avutil*.dll" "$dst\" -Force -ErrorAction SilentlyContinue
          Copy-Item "$src\swscale*.dll" "$dst\" -Force -ErrorAction SilentlyContinue
        } else {
          Write-Host "Warning: FFmpeg bin directory not found"
        }
        
        if (Test-Path "build\Release\udp_streamer.exe") {
          Write-Host "Executable created successfully"
          Get-Item "build\Release\udp_streamer.exe"
        } else {
          Write-Host "ERROR: Executable not found"
          exit 1
        }
      shell: powershell
    
    - name: List output directory
      run: |
        Write-Host "Contents of build\Release:"
        Get-ChildItem "build\Release" -Recurse
      shell: powershell
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: udp-streamer-cpp-windows-x64
        path: build/Release/udp_streamer.exe
        retention-days: 30
        if-no-files-found: error
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: build/Release/udp_streamer.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}





  release:
    name: Create Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-windows-cpp]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: Create Release Notes
      run: |
        cat > RELEASE_NOTES.md << 'EOF'
        # UDP Streamer Release (Windows x64)
        
        ## Downloads
        
        - **Windows C++ (x64)**: udp-streamer-cpp-windows-x64/udp_streamer.exe
        
        ## Usage
        
        ```bash
        udp_streamer.exe -ip 192.168.1.100 -p 10000 -w 1920 -h 1080 -fps 30 -br 5000
        ```
        
        ## Changes
        See [commits](https://github.com/${{ github.repository }}/compare/...v${{ github.ref_name }})
        EOF
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        body_path: RELEASE_NOTES.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
