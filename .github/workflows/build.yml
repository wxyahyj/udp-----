name: Build UDP Streamer

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows-cpp:
    name: Build C++ on Windows (x64)
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup CMake and Dependencies
      run: |
        choco install cmake --no-progress -y
        cmake --version
      shell: powershell
    
    - name: Setup Visual Studio Build Tools
      uses: microsoft/setup-msbuild@v1.1
    
    - name: Download FFmpeg (Pre-built)
      run: |
        $ProgressPreference = 'SilentlyContinue'
        Write-Host "Downloading FFmpeg..."
        
        # 使用 GitHub releases 作为备份源
        $ffmpeg_urls = @(
          "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-dev.zip",
          "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-full-dev.zip"
        )
        
        $downloaded = $false
        foreach ($url in $ffmpeg_urls) {
          try {
            Write-Host "尝试从 $url 下载..."
            Invoke-WebRequest -Uri $url -OutFile "ffmpeg.zip" -TimeoutSec 60
            $downloaded = $true
            Write-Host "✓ FFmpeg 下载成功"
            break
          }
          catch {
            Write-Host "✗ 下载失败，尝试下一个源..."
          }
        }
        
        if (-not $downloaded) {
          Write-Host "ERROR: 无法从任何源下载 FFmpeg"
          exit 1
        }
        
        Write-Host "Extracting FFmpeg..."
        Expand-Archive -Path "ffmpeg.zip" -DestinationPath "." -Force
        
        $ffmpeg_dir = Get-ChildItem -Directory -Filter "ffmpeg*" | Select-Object -First 1
        if (-not $ffmpeg_dir) {
          Write-Host "ERROR: FFmpeg directory not found"
          exit 1
        }
        
        $ffmpeg_path = $ffmpeg_dir.FullName
        Write-Host "FFmpeg path: $ffmpeg_path"
        echo "FFMPEG_PATH=$ffmpeg_path" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      shell: powershell
    
    - name: Verify FFmpeg
      run: |
        Write-Host "Checking FFmpeg structure..."
        $ffmpeg = "${{ env.FFMPEG_PATH }}"
        Get-ChildItem "$ffmpeg" -Recurse -Filter "*.lib" | Select-Object -First 5
        Get-ChildItem "$ffmpeg" -Recurse -Filter "*.h" | Select-Object -First 5
      shell: powershell
    
    - name: Configure CMake
      run: |
        mkdir build -ErrorAction SilentlyContinue
        cd build
        
        $ffmpeg_path = "${{ env.FFMPEG_PATH }}"
        Write-Host "Configuring with FFmpeg path: $ffmpeg_path"
        
        cmake -G "Visual Studio 17 2022" `
          -A x64 `
          -DFFMPEG_PATH="$ffmpeg_path" `
          -DCMAKE_BUILD_TYPE=Release `
          ..
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "CMake configuration failed"
          exit 1
        }
      shell: powershell
    
    - name: Build C++ Project
      run: |
        cd build
        cmake --build . --config Release --parallel 4
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Build failed"
          exit 1
        }
      shell: powershell
    
    - name: Copy FFmpeg DLLs
      run: |
        $src = "${{ env.FFMPEG_PATH }}\bin"
        $dst = "build\Release"
        
        if (Test-Path $src) {
          Write-Host "Copying FFmpeg DLLs from $src to $dst"
          Copy-Item "$src\*.dll" "$dst\" -Force -ErrorAction SilentlyContinue
        }
        
        if (Test-Path "build\Release\udp_streamer.exe") {
          Write-Host "✓ Executable created successfully"
          Get-Item "build\Release\udp_streamer.exe"
        } else {
          Write-Host "✗ Executable not found"
          exit 1
        }
      shell: powershell
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: udp-streamer-cpp-windows-x64
        path: build/Release/udp_streamer.exe
        retention-days: 30
        if-no-files-found: error
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: build/Release/udp_streamer.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}





  release:
    name: Create Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-windows-cpp]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: Create Release Notes
      run: |
        cat > RELEASE_NOTES.md << 'EOF'
        # UDP Streamer Release (Windows x64)
        
        ## Downloads
        
        - **Windows C++ (x64)**: udp-streamer-cpp-windows-x64/udp_streamer.exe
        
        ## Usage
        
        ```bash
        udp_streamer.exe -ip 192.168.1.100 -p 10000 -w 1920 -h 1080 -fps 30 -br 5000
        ```
        
        ## Changes
        See [commits](https://github.com/${{ github.repository }}/compare/...v${{ github.ref_name }})
        EOF
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        body_path: RELEASE_NOTES.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
