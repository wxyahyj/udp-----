name: Build UDP Streamer

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows-cpp:
    name: Build C++ on Windows
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, x86]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup CMake
      run: |
        choco install cmake --no-progress -y
        cmake --version
      shell: powershell
    
    - name: Setup Visual Studio
      uses: microsoft/setup-msbuild@v1.1
    
    - name: Download FFmpeg
      run: |
        $ProgressPreference = 'SilentlyContinue'
        Invoke-WebRequest -Uri "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-full-shared.zip" `
          -OutFile "ffmpeg.zip"
        Expand-Archive -Path "ffmpeg.zip" -DestinationPath "."
        dir
        $ffmpeg_dir = Get-ChildItem -Directory -Filter "ffmpeg*" | Select-Object -First 1
        echo "FFMPEG_PATH=$($ffmpeg_dir.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      shell: pwsh
    
    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake -G "Visual Studio 17 2022" -A ${{ matrix.arch }} `
          -DFFMPEG_INCLUDE_DIRS="${{ env.FFMPEG_PATH }}\include" `
          -DFFMPEG_LIBRARIES="${{ env.FFMPEG_PATH }}\lib\avcodec.lib;${{ env.FFMPEG_PATH }}\lib\avformat.lib;${{ env.FFMPEG_PATH }}\lib\swscale.lib" `
          ..
      shell: cmd
    
    - name: Build
      run: |
        cd build
        cmake --build . --config Release
      shell: cmd
    
    - name: Copy FFmpeg DLLs
      run: |
        Copy-Item "${{ env.FFMPEG_PATH }}\bin\*.dll" "build\Release\" -Force
      shell: pwsh
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: udp-streamer-cpp-windows-${{ matrix.arch }}
        path: build/Release/udp_streamer.exe
        retention-days: 30
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: build/Release/udp_streamer.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


  build-python:
    name: Build Python Package
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build standalone executable (Linux)
      run: |
        pyinstaller --onefile --name udp_streamer \
          --hidden-import=cv2 \
          --hidden-import=mss \
          --collect-all cv2 \
          udp_streamer.py
    
    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: udp-streamer-python-linux
        path: dist/udp_streamer
        retention-days: 30


  build-python-windows:
    name: Build Python Package for Windows
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build standalone executable
      run: |
        pyinstaller --onefile --name udp_streamer.exe `
          --hidden-import=cv2 `
          --hidden-import=mss `
          --collect-all cv2 `
          udp_streamer.py
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: udp-streamer-python-windows
        path: dist/udp_streamer.exe
        retention-days: 30
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/udp_streamer.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: udp-streamer:test
    
    - name: Create Release (Docker)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        body: |
          Docker image built successfully.
          
          Instructions:
          ```bash
          docker build -t udp-streamer:${{ github.ref_name }} .
          docker run -it --rm udp-streamer:${{ github.ref_name }} \
            -ip 192.168.1.100 -p 10000
          ```
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


  test-cpp:
    name: Test C++ Build
    runs-on: windows-latest
    needs: build-windows-cpp
    
    steps:
    - name: Download C++ artifact
      uses: actions/download-artifact@v4
      with:
        name: udp-streamer-cpp-windows-x64
    
    - name: Check executable
      run: |
        if (Test-Path "udp_streamer.exe") {
          Write-Host "✓ Executable built successfully"
          & ".\udp_streamer.exe" --help 2>&1 | head -5
        } else {
          Write-Host "✗ Executable not found"
          exit 1
        }
      shell: pwsh


  release:
    name: Create Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-windows-cpp, build-python, build-python-windows, build-docker]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: Create Release Notes
      run: |
        cat > RELEASE_NOTES.md << 'EOF'
        # UDP Streamer Release
        
        ## Downloads
        
        - **Windows C++ (x64)**: udp-streamer-cpp-windows-x64/udp_streamer.exe
        - **Windows C++ (x86)**: udp-streamer-cpp-windows-x86/udp_streamer.exe
        - **Windows Python**: udp-streamer-python-windows/udp_streamer.exe
        - **Linux Python**: udp-streamer-python-linux/udp_streamer
        
        ## Usage
        
        ### C++ Version
        ```bash
        udp_streamer.exe -ip 192.168.1.100 -p 10000 -w 1920 -h 1080 -fps 30 -br 5000
        ```
        
        ### Python Version
        ```bash
        udp_streamer.exe -ip 192.168.1.100 -p 10000 --help
        ```
        
        ### Docker
        ```bash
        docker pull ${{ secrets.DOCKER_USERNAME }}/udp-streamer:${{ github.ref_name }}
        docker run -it --rm ${{ secrets.DOCKER_USERNAME }}/udp-streamer:${{ github.ref_name }}
        ```
        
        ## Changes
        See [commits](https://github.com/${{ github.repository }}/compare/...v${{ github.ref_name }})
        EOF
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        body_path: RELEASE_NOTES.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
