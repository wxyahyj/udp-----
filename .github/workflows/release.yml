name: Publish Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  publish-release:
    name: Publish Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Get version
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Release version: ${VERSION}"
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        body: |
          # UDP Streamer Release ${{ steps.version.outputs.version }}
          
          ## Downloads
          
          - **Windows C++ (x64)**: Compiled with MSVC
          - **Windows C++ (x86)**: 32-bit compatibility
          - **Windows Python**: PyInstaller package
          - **Linux Python**: PyInstaller package
          
          ## Features
          - Hardware-accelerated video encoding (NVIDIA/AMD)
          - Multi-threaded streaming pipeline
          - Adaptive bitrate control
          - Cross-platform support
          
          See source code for build instructions.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


  publish-docker:
    name: Build and Test Docker
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image test
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: udp-streamer:test
    
    - name: Create Docker Release Note
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/v')
      with:
        body: |
          Docker image available. Build locally:
          ```bash
          docker build -t udp-streamer:${{ github.ref_name }} .
          docker run -it --rm udp-streamer:${{ github.ref_name }} \
            -ip 192.168.1.100 -p 10000
          ```
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


  notify-release:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [publish-release]
    
    steps:
    - name: Get version
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
    
    - name: Release notification
      run: |
        echo "âœ… Release ${{ steps.version.outputs.version }} published successfully!"
        echo "ğŸ“¦ Check GitHub Releases for downloads"
        echo "ğŸ³ Docker image available for local build"
